<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>future-queue - nextest-rs/future-queue zh-TW</title>
    <meta name="title" content="future-queue - nextest-rs/future-queue zh-TW | future-queue future_queue 提供了執行多個 future 的方式： 並發執行 依照它們被啟動的順序 全域限制 並可為每個 future 指定一個可選的群組，每個群組有其自己的限制。 這個 crate 屬於 GitHub 上的 nextest 組織， 並設計來滿足 cargo-nextest 的需...">
    <meta name="description" content="nextest-rs/future-queue - GitHub repository zh-TW documentation and information | future-queue future_queue 提供了執行多個 future 的方式： 並發執行 依照它們被啟動的順序 全域限制 並可為每個 future 指定一個可選的群組，每個群組有其自己的限制。 這個 crate 屬於 GitHub 上的 nextest 組織， 並設計來滿足 cargo-nextest 的需...">
    <meta name="keywords" content="nextest-rs, future-queue, GitHub, repository, zh-TW documentation">
    <meta name="author" content="Open AI Tx">
    <meta name="robots" content="index, follow">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://openaitx.github.io/projects/nextest-rs/future-queue/README-zh-TW.html">
    <meta property="og:title" content="future-queue - nextest-rs/future-queue zh-TW | future-queue future_queue 提供了執行多個 future 的方式： 並發執行 依照它們被啟動的順序 全域限制 並可為每個 future 指定一個可選的群組，每個群組有其自己的限制。 這個 crate 屬於 GitHub 上的 nextest 組織， 並設計來滿足 cargo-nextest 的需...">
    <meta property="og:description" content="nextest-rs/future-queue - GitHub repository zh-TW documentation and information | future-queue future_queue 提供了執行多個 future 的方式： 並發執行 依照它們被啟動的順序 全域限制 並可為每個 future 指定一個可選的群組，每個群組有其自己的限制。 這個 crate 屬於 GitHub 上的 nextest 組織， 並設計來滿足 cargo-nextest 的需...">
    <meta property="og:image" content="https://openaitx.github.io/logo_crop.png">
    <link rel="icon" type="image/jpeg" href="/icon.jpg">
    <link rel="apple-touch-icon" href="/icon.jpg">
    <script src="/js/marked.min.js?v=20250613"></script>
    <link rel="stylesheet" href="/css/github.min.css?v=20250613">
    <script src="/js/highlight.min.js?v=20250613"></script>
    <link rel="stylesheet" href="/view.css?v=20250613">
    <style>
        body { display: flex; flex-direction: column; min-height: 100vh; }
        .main-container { margin: 0 auto; width: 100%; max-width: 980px; padding: 0 20px; }
        @media (max-width: 768px) { .main-container { padding: 0 15px; } }
        .markdown-body img { max-width: 100%; height: auto; }
        .header { text-align: center; margin-bottom: 30px; padding: 20px; background-color: #f6f8fa; border-bottom: 1px solid #e1e4e8; position: relative; }
        .header .links { margin-top: 10px; font-size: 16px; }
        .header .links a { color: #0366d6; text-decoration: none; margin-left: 5px; }
        .header .links a:hover { text-decoration: underline; }
        .language-badges { margin-top: 15px; text-align: center; }
        .language-badges a { display: inline-block; margin: 2px; text-decoration: none; }
        .language-badges img { height: 20px; border-radius: 3px; }
        .language-badges a:hover img { opacity: 0.8; }
    </style>
</head>
<body>
    <div class="header">
        <div class="links">
            GitHub Repository: <a href="https://github.com/nextest-rs/future-queue" id="githubRepoLink" target="_blank">nextest-rs/future-queue</a>
<h1 style="display: none;">future-queue future_queue 提供了執行多個 future 的方式： 並發執行 依照它們被啟動的順序 全域限制 並可為每個 future 指定一個可選的群組，每個群組有其自己的限制。 這個 crate 屬於 GitHub 上的 nextest 組織， 並設計來滿足 cargo-nextest 的需...</h1>
        </div>
        <div class="language-badges" id="languageBadges">
            <!-- You can generate language badges here if needed -->
        </div>
    </div>
    <div class="main-container">
        <div class="markdown-body" id="content">
            <h1>future-queue</h1>
<p><a href="https://crates.io/crates/future-queue"><img src="https://img.shields.io/crates/v/future-queue" alt="future-queue on crates.io" /></a>
<a href="https://docs.rs/future-queue/"><img src="https://img.shields.io/badge/docs-latest-brightgreen.svg" alt="Documentation (latest release)" /></a>
<a href="https://nextest-rs.github.io/future-queue/rustdoc/future_queue"><img src="https://img.shields.io/badge/docs-main-purple" alt="Documentation (main)" /></a>
<a href="https://raw.githubusercontent.com/nextest-rs/future-queue/main/CHANGELOG.md"><img src="https://img.shields.io/badge/changelog-latest-blue" alt="Changelog" /></a>
<a href="https://raw.githubusercontent.com/nextest-rs/future-queue/main/LICENSE-APACHE"><img src="https://img.shields.io/badge/license-Apache-green.svg" alt="License" /></a>
<a href="https://raw.githubusercontent.com/nextest-rs/future-queue/main/LICENSE-MIT"><img src="https://img.shields.io/badge/license-MIT-green.svg" alt="License" /></a></p>
<p><code>future_queue</code> 提供了執行多個 future 的方式：</p>
<ul>
<li>並發執行</li>
<li>依照它們被啟動的順序</li>
<li>全域限制</li>
<li>並可為每個 future 指定一個可選的群組，每個群組有其自己的限制。</li>
</ul>
<p>這個 crate 屬於 GitHub 上的 <a href="https://github.com/nextest-rs">nextest 組織</a>，
並設計來滿足 <a href="https://nexte.st">cargo-nextest</a> 的需求。</p>
<h2>動機</h2>
<p>Rust 的非同步程式設計經常使用一個稱為
<a href="https://docs.rs/futures/latest/futures/stream/trait.StreamExt.html#method.buffer_unordered"><code>buffer_unordered</code></a> 的 adaptor：
這個 adaptor 接收一個 future 的 stream[^1]，並以最大併發數限制來執行所有 future。</p>
<ul>
<li>futures 會按照 stream 回傳它們的順序被啟動。</li>
<li>一旦被啟動，futures 會同時被 poll，完成的 future 輸出會以任意順序回傳（因此稱為 <code>unordered</code>）。</li>
</ul>
<p><code>buffer_unordered</code> 的常見使用情境包括：</p>
<ul>
<li>並發發送網路請求，但限制併發數以避免壓垮遠端伺服器。</li>
<li>使用像 <a href="https://nexte.st">cargo-nextest</a> 這樣的工具執行測試。</li>
</ul>
<p><code>buffer_unordered</code> 適用於許多情境。然而，它的一個問題是將所有 future 視為同等消耗：無法指定某些 future 消耗的資源比其他多，或是某些 future 的子集需要彼此互斥。</p>
<p>對 nextest 而言，某些測試可能比其他測試更重，因此同時執行的這類測試數量應更少。此外，某些測試需要與其他測試互斥，或者對它們施加其他併發限制。</p>
<p>[^1]: 為了最大通用性，這個 adaptor 接收的是 future 的 stream。實務上，這通常是一個 <em>iterator</em>，經由
<a href="https://docs.rs/futures/latest/futures/stream/fn.iter.html"><code>stream::iter</code></a> 轉換而來。</p>
<h2>關於本 crate</h2>
<p>本 crate 為 stream 提供了兩個 adaptor。</p>
<h3>1. <code>future_queue</code> adaptor</h3>
<p><a href="StreamExt::future_queue"><code>future_queue</code></a> adaptor 能同時執行多個 future，
並將併發數限制在最大「權重」。</p>
<p>這個 adaptor 並不是接收一個 future 的 stream，而是接收一個
<code>(usize, F)</code> 組合的 stream，其中 <code>usize</code> 表示每個 future 的權重，
而 <code>F</code> 是 <code>FnOnce(FutureQueueContext) -&gt; impl Future</code>。這個 adaptor
會排程並緩衝要執行的 futures，直到佇列中的下一個 future 會超過最大權重才停止。</p>
<ul>
<li>當 futures 執行時，最大權重永遠不會被超過。</li>
<li>如果單一 future 的權重大於最大權重，其權重會被設為最大權重。</li>
</ul>
<p>一旦所有能排程的 futures 都已安排，這個 adaptor 會等到部分目前執行中的 futures 完成，
且目前執行中的權重降到最大權重以下，再安排新的 future。</p>
<p>future 的權重可以是零，此時它不會計入最大權重。</p>
<p>如果所有權重都是 1，則 <code>future_queue</code> 等同於 <code>buffer_unordered</code>。</p>
<h4>範例</h4>
<pre><code class="language-rust">use futures::{channel::oneshot, stream, StreamExt as _};
use future_queue::{StreamExt as _};

let (send_one, recv_one) = oneshot::channel();
let (send_two, recv_two) = oneshot::channel();

let stream_of_futures = stream::iter(
    vec![(1, recv_one), (2, recv_two)],
).map(|(weight, future)| {
    (weight, move |_cx| future)
});
let mut queue = stream_of_futures.future_queue(10);

send_two.send(&quot;hello&quot;)?;
assert_eq!(queue.next().await, Some(Ok(&quot;hello&quot;)));

send_one.send(&quot;world&quot;)?;
assert_eq!(queue.next().await, Some(Ok(&quot;world&quot;)));

assert_eq!(queue.next().await, None);
</code></pre>
<h3>2. <code>future_queue_grouped</code> adaptor</h3>
<p><a href="StreamExt::future_queue_grouped"><code>future_queue_grouped</code></a> adaptor 類似於 <code>future_queue</code>，
但允許為每個 future 指定一個可選的「群組」。每個群組有一個最大權重，
只有當全域最大權重與該群組權重皆未超過時，future 才會被排程。</p>
<p>此 adaptor 會在限制條件下盡可能公平：它會按照 stream 回傳的順序排程 futures，
不會根據權重重新排序。當某群組的 future 完成時，該群組中排隊的 futures 會被優先排程，
再輪到來自其他群組的 future。</p>
<p>與 <a href="StreamExt::future_queue"><code>future_queue</code></a> 一樣：</p>
<ul>
<li>當 futures 執行時，最大全域權重與群組權重都不會被超過。</li>
<li>計算全域權重時，若單一 future 的權重大於最大權重，其權重會被設為最大權重。</li>
<li><em>若 future 屬於某個群組：</em> 計算群組權重時，若其權重大於最大群組權重，其權重會被設為最大群組權重。</li>
</ul>
<h4>範例</h4>
<pre><code class="language-rust">use futures::{channel::oneshot, stream, StreamExt as _};
use future_queue::{FutureQueueContext, StreamExt as _};

let (send_one, recv_one) = oneshot::channel();
let (send_two, recv_two) = oneshot::channel();

let stream_of_futures = stream::iter(
    vec![
        (1, Some(&quot;group1&quot;), recv_one),
        (2, None, recv_two),
    ],
).map(|(weight, group, future)| {
    (weight, group, move |_cx| future)
});
let mut queue = stream_of_futures.future_queue_grouped(10, [(&quot;group1&quot;, 5)]);

send_two.send(&quot;hello&quot;)?;
assert_eq!(queue.next().await, Some(Ok(&quot;hello&quot;)));

send_one.send(&quot;world&quot;)?;
assert_eq!(queue.next().await, Some(Ok(&quot;world&quot;)));

assert_eq!(queue.next().await, None);
</code></pre>
<h2>最低支援 Rust 版本（MSRV）</h2>
<p>最低支援的 Rust 版本為 <strong>Rust 1.70。</strong> 任一時刻，至少支援過去六個月的 Rust 穩定版。</p>
<p>在這個 crate 為預發佈（0.x.x）期間，MSRV 可能會在 patch 版升級時調高。當這個 crate 達到 1.x 後，
任何 MSRV 的調升都會隨著新的次版本一同發佈。</p>
<h2>備註</h2>
<p>本 crate 原名為 <code>buffer-unordered-weighted</code>，後來更名為 <code>future-queue</code>，
以更清楚描述 crate 的功能而非實作方式。</p>
<h2>貢獻方式</h2>
<p>請參閱 <a href="https://raw.githubusercontent.com/nextest-rs/future-queue/main/CONTRIBUTING.md">CONTRIBUTING</a> 文件了解如何參與貢獻。</p>
<h2>授權條款</h2>
<p>本專案可依 <a href="https://raw.githubusercontent.com/nextest-rs/future-queue/main/LICENSE-APACHE">Apache 2.0 授權</a> 或
<a href="https://raw.githubusercontent.com/nextest-rs/future-queue/main/LICENSE-MIT">MIT 授權</a> 進行使用。</p>
<p>本程式碼源自 <a href="https://github.com/rust-lang/futures-rs">futures-rs</a>，
並依 Apache 2.0 與 MIT 授權條款使用。</p>
<!--
README.md 是由 cargo readme 依據 README.tpl 產生。如需重新產生，請於專案根目錄執行：

./scripts/regenerate-readmes.sh
-->
<hr />
<p>Tranlated By <a href="https://github.com/OpenAiTx/OpenAiTx">Open Ai Tx</a> | Last indexed: 2025-06-07</p>
<hr />

        </div>
    </div>
    <footer class="footer">
        Powered by <a href="https://github.com/OpenAiTx/OpenAiTx" target="_blank">Open AI Tx</a>
    </footer>
    <!-- Default Statcounter code for openaitx
https://openaitx.github.io/ -->
    <script type="text/javascript">
        var sc_project = 13142514;
        var sc_invisible = 1;
        var sc_security = "d03a31d8"; 
    </script>
    <script type="text/javascript" src="https://www.statcounter.com/counter/counter.js" async></script>
    <noscript>
        <div class="statcounter"><a title="Web Analytics" href="https://statcounter.com/" target="_blank"><img
                    class="statcounter" src="https://c.statcounter.com/13142514/0/d03a31d8/1/" alt="Web Analytics"
                    referrerPolicy="no-referrer-when-downgrade"></a></div>
    </noscript>
    <!-- End of Statcounter Code -->
</body>
</html>